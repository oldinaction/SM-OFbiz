<?xml version="1.0" encoding="UTF-8" ?>
<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/simple-methods-v2.xsd">
	
	<simple-method method-name="createSmPerson" short-description="产生一条SmPerson记录">
		<log message="${parameters.hasPermission}" level="info" />

		<check-permission permission="AEZO" action="_CREATE"
			error-list-name="errorList">
			<alt-permission permission="AEZO" action="_UPDATE" /><!-- 备用权限检查 -->
			<!-- 给当前登录用户分配的备用权限, 若<check-permission>权限校验为false, 继续校验此标签配置权限, 若为true, 则权限校验通过; <alt-permission>可以多个 -->
			<!-- check-permission 和 alt-permission 两者的关系是or的关系，即只要两者有一个满足权限要求即可。 -->

			<fail-message message="您没有操作权限" />
			<!-- <fail-property resource="AezoUiLabels" property="AezoPermissionError"/> -->
		</check-permission>
		<!-- 不管check-permission检验的结果是true/false，最终后面的代码仍然会执行。如果为false就会将fail-message或者fail-property的值放到error-list-name中 -->

		<if-has-permission permission="AEZO" action="_ADMIN">
			<make-value entity-name="SmPerson" value-field="newEntity" /><!-- 创建一个SmPerson实体对象 -->
			<sequenced-id sequence-name="SmPerson" field="newEntity.id" /><!-- 递增的主键 -->
			<set field="newEntity.username" value="smalle" /><!-- 设置实体相应字段的值 -->
			<set field="newEntity.password" value="123456" />
			<create-value value-field="newEntity" /><!-- 往数据库新增一条记录 -->
			<else>
				<log message="您没有管理权限" level="info" />
			</else>
		</if-has-permission>

		<if-not-empty field="errorList[0]">
			<log message="${errorList[0]}" level="info" />
		</if-not-empty>
		<log message="执行完毕" level="info" />
	</simple-method>
	
	<simple-method method-name="serviceSecurityCheck" short-description="权限检查逻辑">
		<set field="primaryPermission" value="AEZO" />
		<!-- <call-simple-method method-name="genericBasePermissionCheck" xml-resource="component://common/script/org/ofbiz/common/permission/CommonPermissionServices.xml" /> -->
		<call-simple-method method-name="genericBasePermissionCheck" xml-resource="component://aezo/script/cn/aezo/security/Security.xml"></call-simple-method>
		<log message="${parameters.hasPermission}" level="info" />
	</simple-method>

	<simple-method method-name="genericBasePermissionCheck" short-description="common组件中genericBasePermissionCheck的代码">
		<if-empty field="mainAction">
			<set field="mainAction" from-field="parameters.mainAction" />
			<if-empty field="mainAction">
				<add-error>
					<fail-property resource="CommonUiLabels"
						property="CommonPermissionMainActionAttributeMissing" />
				</add-error>
			</if-empty>
		</if-empty>
		<check-errors />

		<if-empty field="primaryPermission">
			<set field="primaryPermission" from-field="parameters.primaryPermission" />
			<if-empty field="primaryPermission">
				<add-error>
					<fail-property resource="CommonUiLabels"
						property="CommonPermissionPrimaryPermissionMissing" />
				</add-error>
			</if-empty>
		</if-empty>
		<log message="${parameters.primaryPermission}" level="info" />
		<check-errors />
		<log level="verbose"
			message="Checking for primary permission ${primaryPermission}_${mainAction}" />

		<if-empty field="altPermission">
			<set field="altPermission" from-field="parameters.altPermission" />
		</if-empty>
		<if-not-empty field="altPermission">
			<log level="verbose"
				message="Checking for alternate permission ${altPermission}_${mainAction}" />
			<set field="altPermissionList"
				value=", ${altPermission}_${mainAction}, ${altPermission}_ADMIN" />
		</if-not-empty>

		<set field="resourceDescription" from-field="parameters.resourceDescription" />
		<if-empty field="resourceDescription">
			<property-to-field resource="CommonUiLabels"
				property="CommonPermissionThisOperation" field="resourceDescription" />
		</if-empty>
		<if>
			<condition>
				<or>
					<if-has-permission permission="${primaryPermission}"
						action="_${mainAction}" />
					<if-has-permission permission="${altPermission}"
						action="_${mainAction}" />
				</or>
			</condition>
			<then>
				<set field="hasPermission" type="Boolean" value="true" />
				<field-to-result field="hasPermission" />
			</then>
			<else>
				<property-to-field resource="CommonUiLabels"
					property="CommonGenericPermissionError" field="failMessage" />
				<set field="hasPermission" type="Boolean" value="false" />
				<field-to-result field="hasPermission" />
				<field-to-result field="failMessage" />
			</else>
		</if>
	</simple-method>


</simple-methods>
